{"version":3,"sources":["../moh.js/fillWorkbook.js"],"names":["gui","worker","unzip","binary","JSON","parse","pako","inflate","to","zip","string","deflate","showModalAlert","title","msg","$","find","html","end","modal","updateLoadingStatus","text","console","log","hideLoadingStatus","hide","updateStatus","clearStatus","workbookToJson","workbook","result","SheetNames","forEach","sheetName","roa","XLSX","utils","sheet_to_json","Sheets","header","defval","length","document","ready","workbookName","val","url","encodeURIComponent","ajax","type","done","response","success","start","Date","extra","undefined","data","WorkbookGUI","window","height","load","fail","xhr","status","error","responseJSON","message","on","btn","statusText","prop","getData","contentType","stringify","name","open","click","change","e","files","target","f","formData","FormData","append","cache","processData","updateJson"],"mappings":"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","sourcesContent":["let gui, worker;\r\n//\r\n// if (!window.Worker) {\r\n//     showModalAlert('Error', 'This browser does not support web worker, please update your browser.');\r\n//     console.error('This browser does not support web worker, please update your browser.')\r\n// }\r\n// else {\r\n//     worker = new Worker('/moh.js/handsontable/worker.js');\r\n//     worker.onerror = function (e) {\r\n//         console.log('Line: ' + e.lineno);\r\n//         console.log('In: ' + e.filename);\r\n//         console.log('Message: ' + e.message);\r\n//     };\r\n// }\r\n//\r\n// function unzip(binary, cb) {\r\n//     worker.onmessage = function (e) {\r\n//         cb(e.data);\r\n//     };\r\n//     worker.postMessage({cmd: 'unzip', data: binary});\r\n// }\r\n//\r\n// function zip(string, cb) {\r\n//     worker.onmessage = function (e) {\r\n//         cb(e.data);\r\n//     };\r\n//     worker.postMessage({cmd: 'zip', data: string});\r\n// }\r\n\r\nfunction unzip(binary) {\r\n    return JSON.parse(pako.inflate(binary, {to: 'string'}));\r\n}\r\n\r\nfunction zip(string) {\r\n    return pako.deflate(string, {to: 'string'});\r\n}\r\n\r\n\r\nfunction showModalAlert(title, msg) {\r\n    $('#msg-modal').find('h5').html(title).end().find('p').html(msg).end().modal('show');\r\n}\r\n\r\n\r\nfunction updateLoadingStatus(text) {\r\n    console.log('Loading... (' + text + ')');\r\n    $('#loadingText').html('Loading... (' + text + ')');\r\n}\r\n\r\nfunction hideLoadingStatus() {\r\n    $('#loading').hide();\r\n}\r\n\r\nfunction updateStatus(text) {\r\n    $('#status').html('<i class=\"fas fa-spinner fa-spin\"></i> ' + text);\r\n}\r\n\r\nfunction clearStatus(text) {\r\n    $('#status').html('');\r\n}\r\n\r\n\r\n\r\nfunction workbookToJson(workbook) {\r\n    var result = {};\r\n    workbook.SheetNames.forEach(function (sheetName) {\r\n        var roa = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1, defval: ''});\r\n        if (roa.length) result[sheetName] = roa;\r\n    });\r\n    console.log(result);\r\n    return result;\r\n}\r\n\r\n\r\n$(document).ready(function () {\r\n    //updateLoadingStatus('downloading');\r\n    const workbookName = $('#filled-workbook').val();\r\n    // default url is for fill the workbook first time\r\n    var url = '/api/filled-workbook/' + encodeURIComponent(workbookName);\r\n    $.ajax({\r\n        url: url,\r\n        type: 'GET',\r\n    }).done(function (response) {\r\n        console.log(response);\r\n        if (response.success) {\r\n            //updateLoadingStatus('unzipping');\r\n            let start = new Date();\r\n            const extra = (response.workbook.extra === undefined ? null: unzip(response.workbook.extra));\r\n            const data = response.workbook.data;\r\n            //updateLoadingStatus('rendering');\r\n            console.log('unzipping takes: ' + (new Date() - start) + 'ms');\r\n            console.log(data);\r\n            gui = new WorkbookGUI('view', workbookName, data, extra, $(window).height() - 305);\r\n            gui.load();\r\n        }\r\n    }).fail(function (xhr, status, error) {\r\n        console.log('fail ' + xhr.responseJSON.message);\r\n        $('#loading').hide();\r\n        //showErrorAlert(xhr.responseJSON.message);\r\n    });\r\n\r\n});\r\n\r\n$('#save-workbook-btn').on('click', function () {\r\n    var btn = $(this);\r\n    var statusText = $('#status');\r\n    statusText.html('<i class=\"fas fa-spinner fa-spin\"></i> Saving');\r\n    btn.prop('disabled', true);\r\n    const data = gui.getData();\r\n\r\n    $.ajax({\r\n        url: '/api/filled-workbook',\r\n        type: 'POST',\r\n        contentType: 'application/json',\r\n        data: JSON.stringify({data: data, name: $('#filled-workbook').val()}),\r\n    }).done(function (response) {\r\n        if (response.success) {\r\n            console.log(response);\r\n            statusText.html('<i class=\"fas fa-check\"></i> Saved');\r\n            btn.prop('disabled', false);\r\n        }\r\n    }).fail(function (xhr, status, error) {\r\n        console.log('fail ' + xhr.responseJSON.message);\r\n        statusText.html('<i class=\"fas fa-times\"></i> Failed to save workbook: ' + xhr.responseJSON.message);\r\n        btn.prop('disabled', false);\r\n    });\r\n\r\n});\r\n\r\n$('#export-workbook-btn').on('click', function () {\r\n    window.open('/api/admin/workbook/' + encodeURIComponent($('#filled-workbook').val()) + '/download');\r\n});\r\n\r\n$('#import-workbook-btn').on('click', function () {\r\n    $('#file-import').click();\r\n});\r\n\r\n$('#file-import').change(function (e) {\r\n    var files = e.target.files, f = files[0];\r\n    var formData = new FormData();\r\n    console.log(f.name);\r\n    formData.append('excel', f);\r\n\r\n    $.ajax({\r\n        url: '/api/upload/workbook/' + encodeURIComponent($('#filled-workbook').val()) + '/' + encodeURIComponent(f.name),\r\n        type: 'POST',\r\n        data: formData,\r\n        cache: false,\r\n        contentType: false,\r\n        processData: false\r\n    }).done(function (response) {\r\n        if (response.success) {\r\n            const data = unzip(response.workbook.data);\r\n            console.log(data);\r\n            gui.updateJson(data);\r\n            gui.load();\r\n        }\r\n    }).fail(function (xhr, status, error) {\r\n        console.log('fail ' + xhr.responseJSON.message);\r\n\r\n    });\r\n});\r\n"],"file":"fillWorkbook.js"}